generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MembershipStatus {
  INVITED
  ACTIVE
  DISABLED
}

enum ScopeType {
  SCOPE_1
  SCOPE_2
  SCOPE_3
}

enum InputMethod {
  MANUAL
  CSV
  OPCUA
  CEMS
}

enum InputType {
  FUEL_GAS_NM3
  DIESEL_L
  GASOLINE_L
  ELECTRICITY_KWH

  CEMS_CO2_KG
  CEMS_CO2_T
  CEMS_CO2_TPH
  CEMS_CO2_CONC_PCT
  STACK_FLOW_NM3H
}

enum EmitterStrategy {
  CALCULATED_FROM_ACTIVITY
  MEASURED_FROM_CEMS
  HYBRID
}

enum PointType {
  SCADA
  CEMS
}

enum ReadingQuality {
  GOOD
  BAD
  UNCERTAIN
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Membership[]
  invites Invite[]

  assets   Asset[]
  emitters Emitter[]
  periods  ReportingPeriod[]
  inputs   GHGInput[]
  results  EmissionResult[]

  apiKeys  ApiKey[]
  points   MeasurementPoint[]
  readings MeasurementReading[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String?
  isSuperAdmin Boolean  @default(false) // <-- dodaj
  createdAt    DateTime @default(now())

  memberships  Membership[]
  accounts     Account[]
  sessions     Session[]
}

model Membership {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  role      MemberRole       @default(VIEWER)
  status    MembershipStatus @default(ACTIVE)
  createdAt DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
}

model Invite {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  role      MemberRole @default(VIEWER)

  tokenHash String   @unique
  expiresAt DateTime
  acceptedAt DateTime?
  createdAt DateTime @default(now())
  createdBy String? // userId admina (opciono)

  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([email])
}


model Asset {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant             @relation(fields: [tenantId], references: [id])
  emitters Emitter[]
  inputs   GHGInput[]
  results  EmissionResult[]
  points   MeasurementPoint[]
  apiKeys  ApiKey[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

model ReportingPeriod {
  id        String   @id @default(cuid())
  tenantId  String
  ym        String // "2026-01"
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())

  tenant  Tenant           @relation(fields: [tenantId], references: [id])
  inputs  GHGInput[]
  results EmissionResult[]

  @@unique([tenantId, ym])
  @@index([tenantId])
}

model Emitter {
  id        String          @id @default(cuid())
  tenantId  String
  assetId   String
  name      String
  scope     ScopeType
  category  String?
  unit      String
  strategy  EmitterStrategy @default(CALCULATED_FROM_ACTIVITY)
  tag       String?
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  asset  Asset  @relation(fields: [assetId], references: [id])

  inputs  GHGInput[]
  results EmissionResult[]
  points  MeasurementPoint[]

  @@unique([tenantId, assetId, name])
  @@index([tenantId])
  @@index([assetId])
  @@index([tenantId, scope])
}

model GHGInput {
  id        String @id @default(cuid())
  tenantId  String
  periodId  String
  assetId   String
  emitterId String

  inputType InputType
  method    InputMethod
  value     Decimal     @db.Decimal(18, 6)
  unit      String
  note      String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant          @relation(fields: [tenantId], references: [id])
  period  ReportingPeriod @relation(fields: [periodId], references: [id])
  asset   Asset           @relation(fields: [assetId], references: [id])
  emitter Emitter         @relation(fields: [emitterId], references: [id])

  @@unique([tenantId, periodId, emitterId, inputType])
  @@index([tenantId])
  @@index([periodId])
  @@index([assetId])
  @@index([emitterId])
}

model EmissionResult {
  id        String @id @default(cuid())
  tenantId  String
  periodId  String
  assetId   String
  emitterId String

  co2  Decimal @db.Decimal(18, 6)
  ch4  Decimal @db.Decimal(18, 6)
  n2o  Decimal @db.Decimal(18, 6)
  co2e Decimal @db.Decimal(18, 6)

  method    String
  createdAt DateTime @default(now())

  tenant  Tenant          @relation(fields: [tenantId], references: [id])
  period  ReportingPeriod @relation(fields: [periodId], references: [id])
  asset   Asset           @relation(fields: [assetId], references: [id])
  emitter Emitter         @relation(fields: [emitterId], references: [id])

  @@index([tenantId])
  @@index([periodId])
  @@index([assetId])
  @@index([emitterId])
}

model ApiKey {
  id        String    @id @default(cuid())
  tenantId  String
  assetId   String?
  name      String
  keyHash   String
  scopes    Json
  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  asset  Asset? @relation(fields: [assetId], references: [id])

  @@index([tenantId])
  @@index([assetId])
}

model MeasurementPoint {
  id        String  @id @default(cuid())
  tenantId  String
  assetId   String
  emitterId String?

  name      String
  pointType PointType
  tag       String
  unit      String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  asset   Asset    @relation(fields: [assetId], references: [id])
  emitter Emitter? @relation(fields: [emitterId], references: [id])

  readings MeasurementReading[]

  @@unique([tenantId, assetId, tag])
  @@index([tenantId])
  @@index([assetId])
  @@index([emitterId])
}

model MeasurementReading {
  id         String         @id @default(cuid())
  tenantId   String
  pointId    String
  ts         DateTime
  value      Decimal        @db.Decimal(18, 6)
  unit       String
  quality    ReadingQuality @default(GOOD)
  receivedAt DateTime       @default(now())

  tenant Tenant           @relation(fields: [tenantId], references: [id])
  point  MeasurementPoint @relation(fields: [pointId], references: [id])

  @@unique([pointId, ts])
  @@index([tenantId])
  @@index([pointId])
  @@index([ts])
}

//
// NextAuth / Auth.js tables
//
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
